name: TTS(full) + Video(summary) TikTok/YouTube -> Telegram (multi-effects)

on:
  repository_dispatch:
    types: [tts_dual_text_to_telegram]
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core fontconfig python3

      - name: Extract inputs from event JSON (safe)
        id: inp
        run: |
          set -euo pipefail
          mkdir -p work

          python3 - <<'PY'
            import json, os, re
            event_path = os.environ["GITHUB_EVENT_PATH"]
            with open(event_path, "r", encoding="utf-8") as f:
              ev = json.load(f)
            
            # workflow_dispatch -> ev.get("inputs")
            # repository_dispatch -> ev.get("client_payload")
            inputs = ev.get("inputs") or {}
            payload = ev.get("client_payload") or {}
            
            summary = (payload.get("summary") or inputs.get("summary") or "").strip()
            full    = (payload.get("full") or inputs.get("full") or "").strip()
            voice   = (payload.get("voice") or inputs.get("voice") or "vi-VN-HoaiMyNeural").strip()
            
            if not summary:
              raise SystemExit("Missing summary (client_payload.summary or inputs.summary)")
            if not full:
              raise SystemExit("Missing full (client_payload.full or inputs.full)")
            
            open("work/summary.txt", "w", encoding="utf-8").write(summary + "\n")
            open("work/full.txt", "w", encoding="utf-8").write(full + "\n")
            open("work/voice.txt", "w", encoding="utf-8").write(voice + "\n")
            
            # one-line summary for title
            summary_oneline = re.sub(r"\s+", " ", summary).strip()
            open("work/summary_oneline.txt", "w", encoding="utf-8").write(summary_oneline + "\n")
            
            print("OK inputs extracted")
          PY

      - name: Prepare title + upload.txt
        id: prep
        run: |
          set -euo pipefail
          export TZ=Asia/Tokyo
          DATE="$(date +%Y-%m-%d)"

          SUMMARY_ONELINE="$(cat work/summary_oneline.txt)"
          # cắt ngắn ~60 ký tự
          SHORT="$(python3 - <<PY
            s = """$SUMMARY_ONELINE"""
            print((s[:60] + "…") if len(s) > 60 else s)
            PY
          )"
          TITLE="${DATE} ${SHORT}"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"

          cat > work/upload.txt <<EOF
Title: $TITLE
Date: $DATE

Summary:
$SUMMARY_ONELINE

Full text:
$(cat work/full.txt)
EOF

      - name: Generate TTS from full text (mp3)
        run: |
          set -euo pipefail
          VOICE="$(cat work/voice.txt)"

          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg text "$(cat work/full.txt)" --arg voice "$VOICE" --arg format "mp3" \
              '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3

          if [ ! -s work/tts.mp3 ]; then
            echo "tts.mp3 is empty. TTS request failed."
            exit 1
          fi

      - name: Wrap summary text for video
        run: |
          set -euo pipefail
          python3 - << 'PY'
            import re
            src = open("work/summary.txt","r",encoding="utf-8").read().strip()
            src = re.sub(r"\s+"," ",src)
            
            def wrap(src, max_chars, max_lines):
              words = src.split(" ")
              lines, cur = [], []
              for w in words:
                if sum(len(x) for x in cur) + len(cur) + len(w) <= max_chars:
                  cur.append(w)
                else:
                  lines.append(" ".join(cur))
                  cur = [w]
              if cur: lines.append(" ".join(cur))
              if len(lines) > max_lines:
                lines = lines[:max_lines-1] + ["… " + lines[max_lines-1]]
              return "\n".join(lines)
            
            open("work/summary_wrapped_tiktok.txt","w",encoding="utf-8").write(wrap(src, 26, 7))
            open("work/summary_wrapped_youtube.txt","w",encoding="utf-8").write(wrap(src, 38, 5))
          PY

      - name: Pick random colors + effect (many)
        id: theme
        run: |
          set -euo pipefail

          BG1_LIST=( "#0B1026" "#120B2E" "#052B2B" "#1B1020" "#0C1B2A" "#19140D" )
          BG2_LIST=( "#3A7BD5" "#7B2FF7" "#00C6A7" "#FF4D6D" "#F7B733" "#2BC0E4" "#F857A6" "#00F5A0" )
          TXT_LIST=( "#FFFFFF" "#EAF2FF" "#FFF7E6" "#E7FFE8" "#F3E8FF" "#FFEAF1" "#F6FFFE" )

          BG1="${BG1_LIST[$((RANDOM % ${#BG1_LIST[@]}))]}"
          BG2="${BG2_LIST[$((RANDOM % ${#BG2_LIST[@]}))]}"
          TXT="${TXT_LIST[$((RANDOM % ${#TXT_LIST[@]}))]}"

          EFFECTS=(rain snow fireworks confetti bokeh stars bubbles scanlines sparkle)
          EFFECT="${EFFECTS[$((RANDOM % ${#EFFECTS[@]}))]}"

          echo "bg1=$BG1" >> "$GITHUB_OUTPUT"
          echo "bg2=$BG2" >> "$GITHUB_OUTPUT"
          echo "txt=$TXT" >> "$GITHUB_OUTPUT"
          echo "effect=$EFFECT" >> "$GITHUB_OUTPUT"

      - name: Render TikTok (1080x1920) + audio
        run: |
          set -euo pipefail

          DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          DUR_S=$(python3 - <<PY
            dur=float("$DUR"); print(max(1.0, dur))
          PY
          )
          FADE_OUT_START=$(python3 - <<PY
            dur=float("$DUR_S"); print(max(0.0, dur-0.7))
          PY
          )

          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi

          BG1="${{ steps.theme.outputs.bg1 }}"
          BG2="${{ steps.theme.outputs.bg2 }}"
          TXT="${{ steps.theme.outputs.txt }}"
          EFFECT="${{ steps.theme.outputs.effect }}"

          if [ "$EFFECT" = "rain" ]; then
            EFFECT_GRAPH="noise=alls=6:allf=u,format=gray,lut='val>245?255:0',scale=1080:3840:flags=neighbor,gblur=sigma=1,format=rgba,colorchannelmixer=aa=0.22,crop=1080:1920:x=0:y='mod(t*900,1920)'"
          elif [ "$EFFECT" = "snow" ]; then
            EFFECT_GRAPH="noise=alls=5:allf=u,format=gray,lut='val>248?255:0',scale=1080:3840:flags=neighbor,gblur=sigma=2,format=rgba,colorchannelmixer=aa=0.20,crop=1080:1920:x='mod(t*40,140)':y='mod(t*280,1920)'"
          elif [ "$EFFECT" = "fireworks" ]; then
            EFFECT_GRAPH="cellauto=s=540x960:rule=110:r=30,scale=1080:1920,format=rgba,gblur=sigma=6,colorchannelmixer=aa=0.22"
          elif [ "$EFFECT" = "confetti" ]; then
            EFFECT_GRAPH="noise=alls=7:allf=u,format=rgba,hue=H='360*t':s=1.6,eq=contrast=1.3,colorchannelmixer=aa=0.18,scale=1080:3840,crop=1080:1920:x='mod(t*90,120)':y='mod(t*650,1920)'"
          elif [ "$EFFECT" = "bokeh" ]; then
            EFFECT_GRAPH="noise=alls=4:allf=u,format=gray,lut='val>235?255:0',gblur=sigma=8,format=rgba,colorchannelmixer=aa=0.18,scale=1080:1920"
          elif [ "$EFFECT" = "stars" ]; then
            EFFECT_GRAPH="noise=alls=5:allf=u,format=gray,lut='val>252?255:0',gblur=sigma=1,format=rgba,colorchannelmixer=aa=0.22"
          elif [ "$EFFECT" = "bubbles" ]; then
            EFFECT_GRAPH="noise=alls=4:allf=u,format=gray,lut='val>248?255:0',gblur=sigma=3,format=rgba,colorchannelmixer=aa=0.16,scale=1080:3840,crop=1080:1920:x='mod(t*30,120)':y='1920-mod(t*420,1920)'"
          elif [ "$EFFECT" = "scanlines" ]; then
            EFFECT_GRAPH="geq=r='0':g='0':b='0':a='if(mod(Y,6)<1,90,0)',format=rgba,scale=1080:1920,colorchannelmixer=aa=0.25"
          else
            EFFECT_GRAPH="noise=alls=6:allf=u,format=gray,lut='val>250?255:0',format=rgba,hue=H='20*t':s=1.8,gblur=sigma=2,colorchannelmixer=aa=0.20"
          fi

          ffmpeg -y \
            -f lavfi -i "color=s=1296x2304:r=30:d=${DUR_S}:c=${BG1}" \
            -f lavfi -i "color=s=1296x2304:r=30:d=${DUR_S}:c=${BG2}" \
            -f lavfi -i "color=s=1080x1920:r=30:d=${DUR_S}:c=black" \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v][1:v]blend=all_mode=overlay:all_opacity=0.55,gblur=sigma=18,vignette=PI/5, \
                zoompan=z='1+0.00035*on':x='(iw-1080)/2':y='(ih-1920)/2':d=1:s=1080x1920:fps=30[base]; \
              [2:v]${EFFECT_GRAPH}[fx]; \
              [base][fx]blend=all_mode=screen:all_opacity=0.95[bgfx]; \
              [bgfx]drawtext=fontfile='${FONT}':textfile=work/summary_wrapped_tiktok.txt:reload=0: \
                x=(w-text_w)/2:y=(h-text_h)/2:fontsize=64:fontcolor=${TXT}:line_spacing=18: \
                box=1:boxcolor=black@0.38:boxborderw=46:shadowcolor=black@0.25:shadowx=2:shadowy=2, \
                fade=t=in:st=0:d=0.40,fade=t=out:st=${FADE_OUT_START}:d=0.70[v]" \
            -map "[v]" -map "3:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k \
            -shortest work/tiktok.mp4

      - name: Render YouTube (1920x1080) + audio
        run: |
          set -euo pipefail

          DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          DUR_S=$(python3 - <<PY
            dur=float("$DUR"); print(max(1.0, dur))
          PY
          )
          FADE_OUT_START=$(python3 - <<PY
            dur=float("$DUR_S"); print(max(0.0, dur-0.7))
          PY
          )

          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi

          BG1="${{ steps.theme.outputs.bg1 }}"
          BG2="${{ steps.theme.outputs.bg2 }}"
          TXT="${{ steps.theme.outputs.txt }}"
          EFFECT="${{ steps.theme.outputs.effect }}"

          if [ "$EFFECT" = "rain" ]; then
            EFFECT_GRAPH="noise=alls=6:allf=u,format=gray,lut='val>245?255:0',scale=1920:2160:flags=neighbor,gblur=sigma=1,format=rgba,colorchannelmixer=aa=0.18,crop=1920:1080:x=0:y='mod(t*700,1080)'"
          elif [ "$EFFECT" = "snow" ]; then
            EFFECT_GRAPH="noise=alls=5:allf=u,format=gray,lut='val>248?255:0',scale=1920:2160:flags=neighbor,gblur=sigma=2,format=rgba,colorchannelmixer=aa=0.16,crop=1920:1080:x='mod(t*35,160)':y='mod(t*220,1080)'"
          elif [ "$EFFECT" = "fireworks" ]; then
            EFFECT_GRAPH="cellauto=s=960x540:rule=110:r=30,scale=1920:1080,format=rgba,gblur=sigma=6,colorchannelmixer=aa=0.18"
          elif [ "$EFFECT" = "confetti" ]; then
            EFFECT_GRAPH="noise=alls=7:allf=u,format=rgba,hue=H='360*t':s=1.6,eq=contrast=1.3,colorchannelmixer=aa=0.14,scale=1920:2160,crop=1920:1080:x='mod(t*120,200)':y='mod(t*420,1080)'"
          elif [ "$EFFECT" = "bokeh" ]; then
            EFFECT_GRAPH="noise=alls=4:allf=u,format=gray,lut='val>235?255:0',gblur=sigma=10,format=rgba,colorchannelmixer=aa=0.14"
          elif [ "$EFFECT" = "stars" ]; then
            EFFECT_GRAPH="noise=alls=5:allf=u,format=gray,lut='val>252?255:0',gblur=sigma=1,format=rgba,colorchannelmixer=aa=0.18"
          elif [ "$EFFECT" = "bubbles" ]; then
            EFFECT_GRAPH="noise=alls=4:allf=u,format=gray,lut='val>248?255:0',gblur=sigma=3,format=rgba,colorchannelmixer=aa=0.12,scale=1920:2160,crop=1920:1080:x='mod(t*30,180)':y='1080-mod(t*260,1080)'"
          elif [ "$EFFECT" = "scanlines" ]; then
            EFFECT_GRAPH="geq=r='0':g='0':b='0':a='if(mod(Y,6)<1,80,0)',format=rgba,scale=1920:1080,colorchannelmixer=aa=0.20"
          else
            EFFECT_GRAPH="noise=alls=6:allf=u,format=gray,lut='val>250?255:0',format=rgba,hue=H='20*t':s=1.8,gblur=sigma=2,colorchannelmixer=aa=0.15"
          fi

          ffmpeg -y \
            -f lavfi -i "color=s=2304x1296:r=30:d=${DUR_S}:c=${BG1}" \
            -f lavfi -i "color=s=2304x1296:r=30:d=${DUR_S}:c=${BG2}" \
            -f lavfi -i "color=s=1920x1080:r=30:d=${DUR_S}:c=black" \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v][1:v]blend=all_mode=overlay:all_opacity=0.55,gblur=sigma=18,vignette=PI/6, \
                zoompan=z='1+0.00030*on':x='(iw-1920)/2':y='(ih-1080)/2':d=1:s=1920x1080:fps=30[base]; \
              [2:v]${EFFECT_GRAPH}[fx]; \
              [base][fx]blend=all_mode=screen:all_opacity=0.95[bgfx]; \
              [bgfx]drawtext=fontfile='${FONT}':textfile=work/summary_wrapped_youtube.txt:reload=0: \
                x=(w-text_w)/2:y=(h-text_h)/2:fontsize=56:fontcolor=${TXT}:line_spacing=16: \
                box=1:boxcolor=black@0.36:boxborderw=40:shadowcolor=black@0.25:shadowx=2:shadowy=2, \
                fade=t=in:st=0:d=0.40,fade=t=out:st=${FADE_OUT_START}:d=0.70[v]" \
            -map "[v]" -map "3:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k \
            -shortest work/youtube.mp4

      - name: Upload to Telegram (caption = date + summary short)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TITLE: ${{ steps.prep.outputs.title }}
        run: |
          set -euo pipefail
          CAPTION="$TITLE"

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/tiktok.mp4 | jq .

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/youtube.mp4 | jq .

          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F document=@work/upload.txt | jq .

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: |
            work/tts.mp3
            work/tiktok.mp4
            work/youtube.mp4
            work/upload.txt
