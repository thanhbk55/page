name: TTS -> Text Video (premium) -> Upload to Telegram

on:
  # Trigger từ hệ thống bên ngoài
  repository_dispatch:
    types: [tts_video_to_telegram]

  # Trigger để test thủ công
  workflow_dispatch:
    inputs:
      text:
        description: "Text input"
        required: true
      voice:
        description: "TTS voice (e.g. vi-VN-HoaiMyNeural)"
        required: false
        default: "vi-VN-HoaiMyNeural"
      caption:
        description: "Telegram caption (optional)"
        required: false
        default: ""
      method:
        description: "Telegram method: sendVideo | sendDocument"
        required: false
        default: "sendVideo"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core fontconfig python3

      - name: Resolve inputs (dispatch or manual)
        id: vars
        run: |
          set -euo pipefail

          TEXT="${{ github.event.client_payload.text }}"
          VOICE="${{ github.event.client_payload.voice }}"
          CAPTION="${{ github.event.client_payload.caption }}"
          METHOD="${{ github.event.client_payload.method }}"

          if [ -z "${TEXT:-}" ]; then TEXT="${{ inputs.text }}"; fi
          if [ -z "${VOICE:-}" ]; then VOICE="${{ inputs.voice }}"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION="${{ inputs.caption }}"; fi
          if [ -z "${METHOD:-}" ]; then METHOD="${{ inputs.method }}"; fi

          if [ -z "${VOICE:-}" ]; then VOICE="vi-VN-HoaiMyNeural"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION=""; fi
          if [ -z "${METHOD:-}" ]; then METHOD="sendVideo"; fi

          {
            echo "text<<EOF"
            echo "$TEXT"
            echo "EOF"
            echo "voice=$VOICE"
            echo "caption=$CAPTION"
            echo "method=$METHOD"
          } >> "$GITHUB_OUTPUT"

      - name: Generate TTS (mp3)
        run: |
          set -euo pipefail
          mkdir -p work

          # lưu text gốc
          cat > work/text.txt << 'EOF'
          ${{ steps.vars.outputs.text }}
          EOF

          # gọi TTS API -> mp3
          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg text "${{ steps.vars.outputs.text }}" \
              --arg voice "${{ steps.vars.outputs.voice }}" \
              --arg format "mp3" \
              '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3

          if [ ! -s work/tts.mp3 ]; then
            echo "tts.mp3 is empty. TTS request failed."
            exit 1
          fi

          ls -lah work/tts.mp3

      - name: Make premium video (no flicker) + merge audio
        run: |
          set -euo pipefail

          # 1) Wrap text cho đẹp (tự xuống dòng theo từ)
          python3 - << 'PY'
          import re
          src = open("work/text.txt","r",encoding="utf-8").read().strip()
          src = re.sub(r"\s+", " ", src)

          words = src.split(" ")
          lines, cur = [], []
          max_chars = 26   # chỉnh 24-30 tùy gu
          for w in words:
            if sum(len(x) for x in cur) + len(cur) + len(w) <= max_chars:
              cur.append(w)
            else:
              lines.append(" ".join(cur))
              cur = [w]
          if cur: lines.append(" ".join(cur))

          max_lines = 7
          if len(lines) > max_lines:
            lines = lines[:max_lines-1] + ["… " + lines[max_lines-1]]

          open("work/text_wrapped.txt","w",encoding="utf-8").write("\n".join(lines))
          print("Wrapped lines:", len(lines))
          PY

          # 2) Duration audio + fade out chuẩn (FIX lỗi DUR)
          DUR=$(ffprobe -v error -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)

          DUR_S=$(python3 - <<PY
          dur=float("$DUR")
          print(max(1.0, dur))
          PY
          )

          FADE_OUT_START=$(python3 - <<PY
          dur=float("$DUR_S")
          print(max(0.0, dur-0.7))
          PY
          )

          echo "Audio duration: $DUR_S sec, fade-out starts: $FADE_OUT_START"

          # 3) Font
          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi
          echo "Using font: $FONT"

          # 4) Render video premium (1080x1920)
          # - base canvas 1296x2304 rồi zoompan crop về 1080x1920 (mượt, sang)
          # - glow layer screen blend
          # - vignette + grain tĩnh (không nháy)
          # - text box mờ, shadow nhẹ
          ffmpeg -y \
            -f lavfi -i "color=s=1296x2304:r=30:d=${DUR_S}:c=black" \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v]format=rgba, \
                geq=r='105+35*sin(2*PI*Y/2304)':g='85+30*sin(2*PI*X/1296)':b='140+30*sin(2*PI*(X+Y)/1900)':a=255, \
                gblur=sigma=18, \
                eq=contrast=1.08:brightness=0.02:saturation=1.10 \
              [bg]; \
              \
              color=s=1296x2304:r=30:d=${DUR_S}:c=black,format=rgba, \
                geq=r='40+20*sin(2*PI*(X+Y)/1200)':g='30+15*sin(2*PI*Y/800)':b='60+18*sin(2*PI*X/900)':a='80', \
                gblur=sigma=45 \
              [glow]; \
              \
              [bg][glow]blend=all_mode=screen:all_opacity=0.35, \
                noise=alls=2:allf=u, \
                vignette=PI/5, \
                zoompan=z='1+0.00035*on':x='(iw-1080)/2':y='(ih-1920)/2':d=1:s=1080x1920:fps=30, \
                drawtext=fontfile='${FONT}': \
                  textfile=work/text_wrapped.txt: \
                  reload=0: \
                  x=(w-text_w)/2: \
                  y=(h-text_h)/2: \
                  fontsize=64: \
                  fontcolor=white: \
                  line_spacing=18: \
                  box=1:boxcolor=black@0.40:boxborderw=44: \
                  shadowcolor=black@0.25:shadowx=2:shadowy=2, \
                fade=t=in:st=0:d=0.40, \
                fade=t=out:st=${FADE_OUT_START}:d=0.70 \
              [v]" \
            -map "[v]" -map "1:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k \
            -shortest \
            work/output.mp4

          ls -lah work/output.mp4

      - name: Upload video to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          METHOD: ${{ steps.vars.outputs.method }}
          CAPTION: ${{ steps.vars.outputs.caption }}
        run: |
          set -euo pipefail

          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/${METHOD}"
          if [ "$METHOD" = "sendDocument" ]; then
            FIELD="document"
          else
            FIELD="video"
          fi

          RESP=$(curl -sS -X POST "$API" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F "$FIELD=@work/output.mp4")

          echo "$RESP" | jq .

          if [ "$METHOD" = "sendDocument" ]; then
            FILE_ID=$(echo "$RESP" | jq -r '.result.document.file_id // empty')
          else
            FILE_ID=$(echo "$RESP" | jq -r '.result.video.file_id // empty')
          fi

          if [ -z "$FILE_ID" ]; then
            echo "Could not extract file_id."
            exit 1
          fi

          echo "file_id=$FILE_ID" | tee work/telegram_result.txt

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: tts-video-output
          path: |
            work/tts.mp3
            work/output.mp4
            work/telegram_result.txt
