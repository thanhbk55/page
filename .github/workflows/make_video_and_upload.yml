name: Make Video And Uload

on:
  repository_dispatch:
    types: [tts_video_to_telegram]

  # để test thủ công
  workflow_dispatch:
    inputs:
      text:
        description: "Text input"
        required: true
      voice:
        description: "TTS voice (e.g. vi-VN-HoaiMyNeural)"
        required: false
        default: "vi-VN-HoaiMyNeural"
      caption:
        description: "Telegram caption (optional)"
        required: false
        default: ""
      method:
        description: "Telegram method: sendVideo | sendDocument"
        required: false
        default: "sendVideo"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core

      - name: Resolve inputs (dispatch or manual)
        id: vars
        run: |
          set -euo pipefail

          TEXT="${{ github.event.client_payload.text }}"
          VOICE="${{ github.event.client_payload.voice }}"
          CAPTION="${{ github.event.client_payload.caption }}"
          METHOD="${{ github.event.client_payload.method }}"

          if [ -z "${TEXT:-}" ]; then TEXT="${{ inputs.text }}"; fi
          if [ -z "${VOICE:-}" ]; then VOICE="${{ inputs.voice }}"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION="${{ inputs.caption }}"; fi
          if [ -z "${METHOD:-}" ]; then METHOD="${{ inputs.method }}"; fi

          if [ -z "${VOICE:-}" ]; then VOICE="vi-VN-HoaiMyNeural"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION=""; fi
          if [ -z "${METHOD:-}" ]; then METHOD="sendVideo"; fi

          # Output
          {
            echo "text<<EOF"
            echo "$TEXT"
            echo "EOF"
            echo "voice=$VOICE"
            echo "caption=$CAPTION"
            echo "method=$METHOD"
          } >> "$GITHUB_OUTPUT"

      - name: Generate TTS (mp3)
        run: |
          set -euo pipefail
          mkdir -p work

          # Lưu text ra file để dễ debug (và dùng cho video)
          cat > work/text.txt << 'EOF'
          ${{ steps.vars.outputs.text }}
          EOF

          # Gọi TTS API (stream) -> tts.mp3
          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg text "${{ steps.vars.outputs.text }}" \
              --arg voice "${{ steps.vars.outputs.voice }}" \
              --arg format "mp3" \
              '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3

          ls -lah work/tts.mp3

      - name: Create beautiful text video (1080x1920) + merge audio
        run: |
          set -euo pipefail

          # Font path (Noto Sans)
          # Ubuntu thường có: /usr/share/fonts/truetype/noto/NotoSans-Regular.ttf
          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            # fallback: pick any noto sans
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi

          echo "Using font: $FONT"

          # Dùng textfile để tránh đau đầu escape ký tự (tiếng Việt, dấu, xuống dòng)
          # Video style:
          # - nền gradient (dùng geq) + noise nhẹ
          # - box mờ sau chữ để đọc rõ
          # - fade in/out nhẹ
          # - ghép audio, -shortest theo audio
          ffmpeg -y \
            -f lavfi -i "color=s=1080x1920:r=30:d=600:c=black" \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v] \
              format=rgba, \
              geq=r='128+60*sin(2*PI*Y/1920)':g='90+60*sin(2*PI*X/1080)':b='150+50*sin(2*PI*(X+Y)/1600)':a=255, \
              noise=alls=8:allf=t+u, \
              gblur=sigma=10, \
              eq=contrast=1.05:brightness=0.02:saturation=1.05, \
              drawtext=fontfile='${FONT}': \
                textfile=work/text.txt: \
                reload=0: \
                x=(w-text_w)/2: \
                y=(h-text_h)/2: \
                fontsize=56: \
                fontcolor=white: \
                line_spacing=14: \
                box=1:boxcolor=black@0.45:boxborderw=38: \
                shadowcolor=black@0.35:shadowx=2:shadowy=2, \
              fade=t=in:st=0:d=0.4, \
              fade=t=out:st=0:d=0.4 \
              [v]" \
            -map "[v]" -map "1:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 20 \
            -c:a aac -b:a 192k \
            -shortest \
            work/output.mp4

          ls -lah work/output.mp4

      - name: Upload video to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          METHOD: ${{ steps.vars.outputs.method }}
          CAPTION: ${{ steps.vars.outputs.caption }}
        run: |
          set -euo pipefail
          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/${METHOD}"

          # METHOD: sendVideo or sendDocument
          if [ "$METHOD" = "sendDocument" ]; then
            FIELD="document"
          else
            FIELD="video"
          fi

          RESP=$(curl -sS -X POST "$API" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F "$FIELD=@work/output.mp4")

          echo "$RESP" | jq .

          if [ "$METHOD" = "sendDocument" ]; then
            FILE_ID=$(echo "$RESP" | jq -r '.result.document.file_id // empty')
          else
            FILE_ID=$(echo "$RESP" | jq -r '.result.video.file_id // empty')
          fi

          if [ -z "$FILE_ID" ]; then
            echo "Could not extract file_id."
            exit 1
          fi

          echo "file_id=$FILE_ID" | tee work/telegram_result.txt

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: tts-video-output
          path: |
            work/tts.mp3
            work/output.mp4
            work/telegram_result.txt
