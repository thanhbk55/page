name: TTS -> Text Video -> Upload to Telegram

on:
  repository_dispatch:
    types: [tts_video_to_telegram]

  # để test thủ công
  workflow_dispatch:
    inputs:
      text:
        description: "Text input"
        required: true
      voice:
        description: "TTS voice (e.g. vi-VN-HoaiMyNeural)"
        required: false
        default: "vi-VN-HoaiMyNeural"
      caption:
        description: "Telegram caption (optional)"
        required: false
        default: ""
      method:
        description: "Telegram method: sendVideo | sendDocument"
        required: false
        default: "sendVideo"

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core

      - name: Resolve inputs (dispatch or manual)
        id: vars
        run: |
          set -euo pipefail

          TEXT="${{ github.event.client_payload.text }}"
          VOICE="${{ github.event.client_payload.voice }}"
          CAPTION="${{ github.event.client_payload.caption }}"
          METHOD="${{ github.event.client_payload.method }}"

          if [ -z "${TEXT:-}" ]; then TEXT="${{ inputs.text }}"; fi
          if [ -z "${VOICE:-}" ]; then VOICE="${{ inputs.voice }}"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION="${{ inputs.caption }}"; fi
          if [ -z "${METHOD:-}" ]; then METHOD="${{ inputs.method }}"; fi

          if [ -z "${VOICE:-}" ]; then VOICE="vi-VN-HoaiMyNeural"; fi
          if [ -z "${CAPTION:-}" ]; then CAPTION=""; fi
          if [ -z "${METHOD:-}" ]; then METHOD="sendVideo"; fi

          # Output
          {
            echo "text<<EOF"
            echo "$TEXT"
            echo "EOF"
            echo "voice=$VOICE"
            echo "caption=$CAPTION"
            echo "method=$METHOD"
          } >> "$GITHUB_OUTPUT"

      - name: Generate TTS (mp3)
        run: |
          set -euo pipefail
          mkdir -p work

          # Lưu text ra file để dễ debug (và dùng cho video)
          cat > work/text.txt << 'EOF'
          ${{ steps.vars.outputs.text }}
          EOF

          # Gọi TTS API (stream) -> tts.mp3
          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg text "${{ steps.vars.outputs.text }}" \
              --arg voice "${{ steps.vars.outputs.voice }}" \
              --arg format "mp3" \
              '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3

          ls -lah work/tts.mp3

      - name: Create beautiful text video (1080x1920) + merge audio
        run: |
          set -euo pipefail

          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi
          echo "Using font: $FONT"
          
          # Lấy độ dài audio (giây)
          DUR=$(ffprobe -v error -show_entries format=duration \
            -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          # Làm tròn xuống và đặt fade-out 0.6s trước khi kết thúc
          DUR_S=$(python3 - << 'PY'
          import math, os
          dur=float(os.environ["DUR"])
          print(max(1.0, dur))
          PY
          )
          FADE_OUT_START=$(python3 - << 'PY'
          import os
          dur=float(os.environ["DUR_S"])
          print(max(0.0, dur-0.6))
          PY
          )
          
          echo "Audio duration: $DUR_S sec, fade-out starts at: $FADE_OUT_START"
          
          ffmpeg -y \
            -f lavfi -i "color=s=1080x1920:r=30:d=${DUR_S}:c=black" \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v] \
                format=rgba, \
                # Gradient ổn định (không đổi theo thời gian)
                geq=r='110+40*sin(2*PI*Y/1920)':g='90+35*sin(2*PI*X/1080)':b='140+35*sin(2*PI*(X+Y)/1600)':a=255, \
                # Noise TĨNH để tránh flicker (allf=u)
                noise=alls=4:allf=u, \
                gblur=sigma=6, \
                eq=contrast=1.06:brightness=0.02:saturation=1.06, \
                drawtext=fontfile='${FONT}': \
                  textfile=work/text.txt: \
                  reload=0: \
                  x=(w-text_w)/2: \
                  y=(h-text_h)/2: \
                  fontsize=56: \
                  fontcolor=white: \
                  line_spacing=14: \
                  box=1:boxcolor=black@0.45:boxborderw=38: \
                  shadowcolor=black@0.30:shadowx=2:shadowy=2, \
                fade=t=in:st=0:d=0.35, \
                fade=t=out:st=${FADE_OUT_START}:d=0.6 \
              [v]" \
            -map "[v]" -map "1:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 20 \
            -c:a aac -b:a 192k \
            -shortest \
            work/output.mp4
          
          ls -lah work/output.mp4

      - name: Upload video to Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          METHOD: ${{ steps.vars.outputs.method }}
          CAPTION: ${{ steps.vars.outputs.caption }}
        run: |
          set -euo pipefail
          API="https://api.telegram.org/bot${TG_BOT_TOKEN}/${METHOD}"

          # METHOD: sendVideo or sendDocument
          if [ "$METHOD" = "sendDocument" ]; then
            FIELD="document"
          else
            FIELD="video"
          fi

          RESP=$(curl -sS -X POST "$API" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F "$FIELD=@work/output.mp4")

          echo "$RESP" | jq .

          if [ "$METHOD" = "sendDocument" ]; then
            FILE_ID=$(echo "$RESP" | jq -r '.result.document.file_id // empty')
          else
            FILE_ID=$(echo "$RESP" | jq -r '.result.video.file_id // empty')
          fi

          if [ -z "$FILE_ID" ]; then
            echo "Could not extract file_id."
            exit 1
          fi

          echo "file_id=$FILE_ID" | tee work/telegram_result.txt

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: tts-video-output
          path: |
            work/tts.mp3
            work/output.mp4
            work/telegram_result.txt
