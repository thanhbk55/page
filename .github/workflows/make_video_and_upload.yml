name: "TTS + Confetti Video TikTok/YouTube -> Telegram"

on:
  repository_dispatch:
    types: [tts_dual_text_to_telegram]
  workflow_dispatch:
    inputs:
      summary:
        description: "Summary text (shown on video)"
        required: true
      full:
        description: "Full text (used for TTS audio)"
        required: true
      background_url:
        description: "Background image URL"
        required: true
      voice:
        description: "TTS voice"
        required: false
        default: "vi-VN-HoaiMyNeural"

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core fontconfig python3 \
            libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install npm deps (canvas + canvas-confetti)
        run: |
          set -euo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Write inputs to files (safe)
        env:
          SUMMARY_DISPATCH: ${{ github.event.client_payload.summary }}
          FULL_DISPATCH: ${{ github.event.client_payload.full }}
          BG_URL_DISPATCH: ${{ github.event.client_payload.background_url }}
          VOICE_DISPATCH: ${{ github.event.client_payload.voice }}
          SUMMARY_INPUT: ${{ inputs.summary }}
          FULL_INPUT: ${{ inputs.full }}
          BG_URL_INPUT: ${{ inputs.background_url }}
          VOICE_INPUT: ${{ inputs.voice }}
        run: |
          set -euo pipefail
          mkdir -p work
          python3 - <<'PY'
          import os
          summary = os.environ.get("SUMMARY_DISPATCH") or os.environ.get("SUMMARY_INPUT") or ""
          full = os.environ.get("FULL_DISPATCH") or os.environ.get("FULL_INPUT") or ""
          bg_url = os.environ.get("BG_URL_DISPATCH") or os.environ.get("BG_URL_INPUT") or ""
          voice = os.environ.get("VOICE_DISPATCH") or os.environ.get("VOICE_INPUT") or "vi-VN-HoaiMyNeural"
          if not summary.strip():
            raise SystemExit("Missing summary")
          if not full.strip():
            raise SystemExit("Missing full")
          if not bg_url.strip():
            raise SystemExit("Missing background_url")
          open("work/summary.txt","w",encoding="utf-8").write(summary.strip()+"\n")
          open("work/full.txt","w",encoding="utf-8").write(full.strip()+"\n")
          open("work/bg_url.txt","w",encoding="utf-8").write(bg_url.strip()+"\n")
          open("work/voice.txt","w",encoding="utf-8").write(voice.strip()+"\n")
          print("OK: wrote summary/full/bg_url/voice")
          PY

      - name: Prepare title + upload.txt
        id: prep
        run: |
          set -euo pipefail
          export TZ=Asia/Tokyo
          DATE="$(date +%Y-%m-%d)"
          python3 - <<'PY'
          import re
          s=open("work/summary.txt","r",encoding="utf-8").read().strip()
          s=re.sub(r"\s+"," ",s)
          short = (s[:60] + "â€¦") if len(s) > 60 else s
          open("work/summary_oneline.txt","w",encoding="utf-8").write(s+"\n")
          open("work/summary_short.txt","w",encoding="utf-8").write(short+"\n")
          PY
          SUMMARY_ONELINE="$(cat work/summary_oneline.txt)"
          SHORT="$(cat work/summary_short.txt)"
          TITLE="${DATE} ${SHORT}"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          cat > work/upload.txt <<EOF
          Title: $TITLE
          Date: $DATE

          Summary:
          $SUMMARY_ONELINE

          Full text:
          $(cat work/full.txt)
          EOF

      - name: Download background image
        run: |
          set -euo pipefail
          BG_URL="$(cat work/bg_url.txt)"
          curl -sS -L "$BG_URL" --output work/background.jpg
          if [ ! -s work/background.jpg ]; then
            echo "background.jpg download failed."
            exit 1
          fi

      - name: Generate TTS from full text (mp3)
        run: |
          set -euo pipefail
          VOICE="$(cat work/voice.txt)"
          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg text "$(cat work/full.txt)" --arg voice "$VOICE" --arg format "mp3" '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3
          if [ ! -s work/tts.mp3 ]; then
            echo "tts.mp3 is empty. TTS request failed."
            exit 1
          fi

      - name: Compute duration
        run: |
          set -euo pipefail
          DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          python3 - <<PY
          dur=float("$DUR")
          dur=max(1.0,dur)
          open("work/duration.txt","w").write(str(dur))
          print(dur)
          PY

      - name: Render frames (confetti overlay)
        run: |
          set -euo pipefail
          DUR="$(cat work/duration.txt)"
          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi

          mkdir -p work/frames_tiktok work/frames_youtube

          node scripts/render_confetti_frames.mjs \
            --w=1080 --h=1920 --fps=30 --dur="$DUR" \
            --bg=work/background.jpg \
            --out=work/frames_tiktok \
            --text="$(cat work/summary_oneline.txt)" \
            --font="$FONT"

          node scripts/render_confetti_frames.mjs \
            --w=1920 --h=1080 --fps=30 --dur="$DUR" \
            --bg=work/background.jpg \
            --out=work/frames_youtube \
            --text="$(cat work/summary_oneline.txt)" \
            --font="$FONT"

      - name: Build TikTok mp4 (frames + audio)
        run: |
          set -euo pipefail
          ffmpeg -y -framerate 30 -i work/frames_tiktok/%04d.png -i work/tts.mp3 \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k -shortest work/tiktok.mp4

      - name: Build YouTube mp4 (frames + audio)
        run: |
          set -euo pipefail
          ffmpeg -y -framerate 30 -i work/frames_youtube/%04d.png -i work/tts.mp3 \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k -shortest work/youtube.mp4

      - name: Upload to Telegram (caption = date + summary short)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TITLE: ${{ steps.prep.outputs.title }}
        run: |
          set -euo pipefail
          CAPTION="$TITLE"
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/tiktok.mp4 | jq .
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/youtube.mp4 | jq .
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F document=@work/upload.txt | jq .

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: |
            work/tts.mp3
            work/tiktok.mp4
            work/youtube.mp4
            work/upload.txt
            work/frames_tiktok
            work/frames_youtube
