name: "TTS + Video TikTok/YouTube -> Telegram"

on:
  repository_dispatch:
    types: [tts_dual_text_to_telegram]
  workflow_dispatch:
    inputs:
      summary:
        description: "Summary text (shown on video)"
        required: true
      full:
        description: "Full text (used for TTS audio)"
        required: true
      background_url:
        description: "Background image URL"
        required: true
      voice:
        description: "TTS voice"
        required: false
        default: "vi-VN-HoaiMyNeural"

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq curl fonts-noto-core fontconfig python3

      - name: Write inputs to files (safe)
        env:
          SUMMARY_DISPATCH: ${{ github.event.client_payload.summary }}
          FULL_DISPATCH: ${{ github.event.client_payload.full }}
          BG_URL_DISPATCH: ${{ github.event.client_payload.background_url }}
          VOICE_DISPATCH: ${{ github.event.client_payload.voice }}
          SUMMARY_INPUT: ${{ inputs.summary }}
          FULL_INPUT: ${{ inputs.full }}
          BG_URL_INPUT: ${{ inputs.background_url }}
          VOICE_INPUT: ${{ inputs.voice }}
        run: |
          set -euo pipefail
          mkdir -p work
          python3 - <<'PY'
          import os
          summary = os.environ.get("SUMMARY_DISPATCH") or os.environ.get("SUMMARY_INPUT") or ""
          full = os.environ.get("FULL_DISPATCH") or os.environ.get("FULL_INPUT") or ""
          bg_url = os.environ.get("BG_URL_DISPATCH") or os.environ.get("BG_URL_INPUT") or ""
          voice = os.environ.get("VOICE_DISPATCH") or os.environ.get("VOICE_INPUT") or "vi-VN-HoaiMyNeural"
          if not summary.strip():
            raise SystemExit("Missing summary")
          if not full.strip():
            raise SystemExit("Missing full")
          if not bg_url.strip():
            raise SystemExit("Missing background_url")
          open("work/summary.txt","w",encoding="utf-8").write(summary.strip()+"\n")
          open("work/full.txt","w",encoding="utf-8").write(full.strip()+"\n")
          open("work/bg_url.txt","w",encoding="utf-8").write(bg_url.strip()+"\n")
          open("work/voice.txt","w",encoding="utf-8").write(voice.strip()+"\n")
          print("OK: wrote summary/full/bg_url/voice")
          PY

      - name: Prepare title + upload.txt
        id: prep
        run: |
          set -euo pipefail
          export TZ=Asia/Tokyo
          DATE="$(date +%Y-%m-%d)"
          SUMMARY_ONELINE="$(python3 - <<'PY'
          import re
          s=open("work/summary.txt","r",encoding="utf-8").read().strip()
          s=re.sub(r"\s+"," ",s)
          print(s)
          PY
          )"
          SHORT="$(python3 - <<PY
          s = """$SUMMARY_ONELINE"""
          print((s[:60] + "…") if len(s) > 60 else s)
          PY
          )"
          TITLE="${DATE} ${SHORT}"
          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          cat > work/upload.txt <<EOF
          Title: $TITLE
          Date: $DATE

          Summary:
          $SUMMARY_ONELINE

          Full text:
          $(cat work/full.txt)
          EOF

      - name: Download background image
        run: |
          set -euo pipefail
          BG_URL="$(cat work/bg_url.txt)"
          curl -sS -L "$BG_URL" --output work/background.jpg
          if [ ! -s work/background.jpg ]; then
            echo "background.jpg download failed."
            exit 1
          fi

      - name: Generate TTS from full text (mp3)
        run: |
          set -euo pipefail
          VOICE="$(cat work/voice.txt)"
          curl -sS -X POST "https://mcp-xiaozhi.vercel.app/api/tts/stream" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg text "$(cat work/full.txt)" --arg voice "$VOICE" --arg format "mp3" '{text:$text, voice:$voice, format:$format}')" \
            --output work/tts.mp3
          if [ ! -s work/tts.mp3 ]; then
            echo "tts.mp3 is empty. TTS request failed."
            exit 1
          fi

      - name: Wrap summary text for video
        run: |
          set -euo pipefail
          python3 - << 'PY'
          import re
          src = open("work/summary.txt","r",encoding="utf-8").read().strip()
          src = re.sub(r"\s+"," ",src)
          def wrap(src, max_chars=26, max_lines=7):
            words = src.split(" ")
            lines, cur = [], []
            for w in words:
              if sum(len(x) for x in cur) + len(cur) + len(w) <= max_chars:
                cur.append(w)
              else:
                lines.append(" ".join(cur))
                cur = [w]
            if cur: lines.append(" ".join(cur))
            if len(lines) > max_lines:
              lines = lines[:max_lines-1] + ["… " + lines[max_lines-1]]
            return "\n".join(lines)
          open("work/summary_wrapped_tiktok.txt","w",encoding="utf-8").write(wrap(src, 26, 7))
          open("work/summary_wrapped_youtube.txt","w",encoding="utf-8").write(wrap(src, 38, 5))
          PY

      - name: Render TikTok (1080x1920) + audio
        run: |
          set -euo pipefail
          DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          DUR_S=$(python3 - <<PY
          dur=float("$DUR"); print(max(1.0, dur))
          PY
          )
          FADE_OUT_START=$(python3 - <<PY
          dur=float("$DUR_S"); print(max(0.0, dur-0.7))
          PY
          )
          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi
          ffmpeg -y \
            -loop 1 -i work/background.jpg \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v]scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920, \
                gblur=sigma=2,eq=brightness=0.05:saturation=0.95[bg]; \
              [bg]drawtext=fontfile='${FONT}':textfile=work/summary_wrapped_tiktok.txt:reload=0: \
                x=(w-text_w)/2:y=(h-text_h)/2:fontsize=64:fontcolor=white:line_spacing=18: \
                box=1:boxcolor=black@0.50:boxborderw=46:shadowcolor=black@0.35:shadowx=3:shadowy=3, \
                fade=t=in:st=0:d=0.40,fade=t=out:st=${FADE_OUT_START}:d=0.70[v]" \
            -map "[v]" -map "1:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k \
            -t ${DUR_S} work/tiktok.mp4

      - name: Render YouTube (1920x1080) + audio
        run: |
          set -euo pipefail
          DUR=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 work/tts.mp3)
          DUR_S=$(python3 - <<PY
          dur=float("$DUR"); print(max(1.0, dur))
          PY
          )
          FADE_OUT_START=$(python3 - <<PY
          dur=float("$DUR_S"); print(max(0.0, dur-0.7))
          PY
          )
          FONT="/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf"
          if [ ! -f "$FONT" ]; then
            FONT="$(fc-list | grep -i "noto sans" | head -n 1 | cut -d: -f1 || true)"
          fi
          ffmpeg -y \
            -loop 1 -i work/background.jpg \
            -i work/tts.mp3 \
            -filter_complex "\
              [0:v]scale=1920:1080:force_original_aspect_ratio=increase,crop=1920:1080, \
                gblur=sigma=2,eq=brightness=0.05:saturation=0.95[bg]; \
              [bg]drawtext=fontfile='${FONT}':textfile=work/summary_wrapped_youtube.txt:reload=0: \
                x=(w-text_w)/2:y=(h-text_h)/2:fontsize=56:fontcolor=white:line_spacing=16: \
                box=1:boxcolor=black@0.48:boxborderw=40:shadowcolor=black@0.35:shadowx=3:shadowy=3, \
                fade=t=in:st=0:d=0.40,fade=t=out:st=${FADE_OUT_START}:d=0.70[v]" \
            -map "[v]" -map "1:a" \
            -c:v libx264 -pix_fmt yuv420p -preset veryfast -crf 19 \
            -c:a aac -b:a 192k \
            -t ${DUR_S} work/youtube.mp4

      - name: Upload to Telegram (caption = date + summary short)
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          TITLE: ${{ steps.prep.outputs.title }}
        run: |
          set -euo pipefail
          CAPTION="$TITLE"
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/tiktok.mp4 | jq .
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendVideo" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F video=@work/youtube.mp4 | jq .
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
            -F chat_id="$TG_CHAT_ID" \
            -F caption="$CAPTION" \
            -F document=@work/upload.txt | jq .

      - name: Upload artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: outputs
          path: |
            work/tts.mp3
            work/tiktok.mp4
            work/youtube.mp4
            work/upload.txt
