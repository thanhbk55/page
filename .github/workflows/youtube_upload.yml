name: YouTube Upload

on:
  workflow_dispatch:
    inputs:
      gdrive_rel_path:
        description: "Relative path inside Drive folder (e.g. folder-a/video.mp4)"
        required: true
      yt_title:
        description: "YouTube title"
        required: true
      yt_description:
        description: "YouTube description"
        required: true
      yt_privacy:
        description: "private|unlisted|public"
        required: false
        default: "public"
      video_mode:
        description: "normal|short (short = trim to <= 3 minutes)"
        required: false
        default: "normal"

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      # OAuth để tải Drive (refresh token cần drive.readonly scope)
      GOOGLE_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
      GOOGLE_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      OUT_PATH: "out/video.mp4"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i googleapis@^140

      - name: Download from Google Drive
        env:
          GDRIVE_REL_PATH: ${{ inputs.gdrive_rel_path }}
        run: |
          node <<'NODE'
          const fs = require("fs");
          const path = require("path");
          const { google } = require("googleapis");

          const clientId = process.env.GOOGLE_CLIENT_ID;
          const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
          const refreshToken = process.env.GOOGLE_REFRESH_TOKEN;

          const rootFolderId = process.env.GDRIVE_FOLDER_ID;
          const relPath = process.env.GDRIVE_REL_PATH;
          const outPath = process.env.OUT_PATH || "out/video.mp4";

          if (!clientId || !clientSecret || !refreshToken) {
            throw new Error("Missing GOOGLE_CLIENT_ID / GOOGLE_CLIENT_SECRET / GOOGLE_REFRESH_TOKEN");
          }
          if (!rootFolderId) throw new Error("Missing GDRIVE_FOLDER_ID");
          if (!relPath) throw new Error("Missing gdrive_rel_path input");

          const parts = relPath.split("/").filter(Boolean);
          if (parts.length < 1) throw new Error("Invalid gdrive_rel_path");

          const oauth2 = new google.auth.OAuth2(clientId, clientSecret);
          oauth2.setCredentials({ refresh_token: refreshToken });
          const drive = google.drive({ version: "v3", auth: oauth2 });

          async function findChild(parentId, name, mimeType) {
            const safeName = name.replace(/'/g, "\\'");
            const q = [
              `'${parentId}' in parents`,
              `name = '${safeName}'`,
              "trashed = false",
              mimeType ? `mimeType = '${mimeType}'` : null,
            ].filter(Boolean).join(" and ");

            const res = await drive.files.list({
              q,
              fields: "files(id,name,mimeType)",
              pageSize: 10,
              supportsAllDrives: true,
              includeItemsFromAllDrives: true,
            });

            return res.data.files?.[0] || null;
          }

          async function main() {
            let currentFolderId = rootFolderId;

            for (let i = 0; i < parts.length - 1; i++) {
              const folderName = parts[i];
              const folder = await findChild(
                currentFolderId,
                folderName,
                "application/vnd.google-apps.folder"
              );
              if (!folder) throw new Error(`Folder not found: ${folderName}`);
              currentFolderId = folder.id;
            }

            const fileName = parts[parts.length - 1];
            const file = await findChild(currentFolderId, fileName, null);
            if (!file) throw new Error(`File not found: ${fileName}`);

            fs.mkdirSync(path.dirname(outPath), { recursive: true });
            const dest = fs.createWriteStream(outPath);

            const res = await drive.files.get(
              { fileId: file.id, alt: "media", supportsAllDrives: true },
              { responseType: "stream" }
            );

            await new Promise((resolve, reject) => {
              res.data.on("end", resolve).on("error", reject).pipe(dest);
            });

            console.log("Downloaded OK:", outPath);
            console.log("Drive fileId:", file.id);
          }

          main().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

      - name: Verify file
        run: |
          ls -lah out
          file out/video.mp4 || true

      - name: Trim video if mode=short (<= 179s)
        if: ${{ inputs.video_mode == 'short' }}
        run: |
          set -euo pipefail
          sudo apt-get update && sudo apt-get install -y ffmpeg

          IN="out/video.mp4"
          OUT="out/video_trim.mp4"
          TRIM_SEC="179"

          echo "Trim to ${TRIM_SEC}s for Shorts..."
          # stream copy first (fast), fallback to re-encode
          ffmpeg -hide_banner -y -i "$IN" -t "$TRIM_SEC" -c copy "$OUT" || \
          ffmpeg -hide_banner -y -i "$IN" -t "$TRIM_SEC" -c:v libx264 -preset veryfast -crf 23 -c:a aac -b:a 128k "$OUT"

          mv -f "$OUT" "$IN"

          # show duration
          ffprobe -v error -show_entries format=duration -of default=nw=1:nk=1 "$IN" || true
          ls -lah out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: video-file
          path: out/video.mp4

  upload:
    runs-on: ubuntu-latest
    needs: download

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: video-file
          path: out

      - name: Verify artifact
        run: |
          ls -lah out
          file out/video.mp4 || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm i googleapis@^140

      - name: Upload to YouTube (Node stream, no OOM)
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

          YT_TITLE: ${{ inputs.yt_title }}
          YT_DESCRIPTION: ${{ inputs.yt_description }}
          YT_PRIVACY: ${{ inputs.yt_privacy }}
        run: |
          node <<'NODE'
          const fs = require("fs");
          const { google } = require("googleapis");

          async function main() {
            let privacy = (process.env.YT_PRIVACY || "private").toLowerCase();
            if (!["private", "unlisted", "public"].includes(privacy)) {
              throw new Error(`Invalid yt_privacy: ${privacy}`);
            }

            const oauth2 = new google.auth.OAuth2(
              process.env.YT_CLIENT_ID,
              process.env.YT_CLIENT_SECRET
            );
            oauth2.setCredentials({ refresh_token: process.env.YT_REFRESH_TOKEN });

            const youtube = google.youtube({ version: "v3", auth: oauth2 });

            const videoPath = "out/video.mp4";
            if (!fs.existsSync(videoPath)) throw new Error(`Video not found: ${videoPath}`);

            const res = await youtube.videos.insert({
              part: ["snippet", "status"],
              notifySubscribers: false,
              requestBody: {
                snippet: {
                  title: process.env.YT_TITLE,
                  description: process.env.YT_DESCRIPTION,
                  categoryId: "22",
                },
                status: { privacyStatus: privacy },
              },
              media: { body: fs.createReadStream(videoPath) },
            });

            console.log("Uploaded video ID:", res.data.id);
            console.log("URL:", `https://www.youtube.com/watch?v=${res.data.id}`);
          }

          main().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE
